<% @changeset.diffs.each do |d| %>
  <a name="file_<%= d.id %>"></a>
  <div class="ui-widget ui-corner-top box">
    <h1>
      <a href="#"><span class="ui-icon ui-icon-document left" 
                        style="margin-right:0.3em"></span>
                        <%= d.updated_file %></a>
      <% add_comment_text = "<span class=\"ui-icon ui-icon-circle-plus left\"></span> Add Comment".html_safe %>
      <%= link_to_function add_comment_text, "add_diff_comment(this);",
          :class => "ui-state-default ui-corner-all button" %>
      <!--<a href="#" class="ui-state-default ui-corner-all button">
        <span class="ui-icon ui-icon-circle-plus left"></span>
        Add Comment</a>-->
    </h1>
    <%= render :partial => "comment", :locals => { :diff => d } %>
    <table cellpadding="0" cellspacing="0" class="diff">
      <% lineno_left = 1 %>
      <% lineno_right = 1 %>
      <% type = "" %>
      <% d.contents.lines.to_a.each do |line| %>
        <% if line =~ /^@@\s+-(\d+),(\d+)\s+\+(\d+),(\d+)\s+@@/ %>
          <% lineno_left = $1.to_i 
             lineno_right = $3.to_i 
             line_text_left = line_text_right = "..." 
             type = "lineno" %>
        <% elsif line =~ /^\+/ %>
          <% line_text_left = "" 
             line_text_right = lineno_right
             type = "new"
             lineno_right += 1 %>
        <% elsif line =~ /^-/ %>
          <% line_text_left = lineno_left
             line_text_right = ""
             type = "old"
             lineno_left += 1 %>
        <% else %>
          <% line_text_left = lineno_left
             line_text_right = lineno_right
             type = ""
             lineno_left += 1
             lineno_right += 1 %>
        <% end %>

        <tr class="<%= type %>">
          <td class="lineno-left"><%= line_text_left %></td>
          <td class="lineno-right"><%= line_text_right %></td>
          <td>
            <b class="add-comment-button">
              <span class="ui-icon ui-icon-plus left"></span>
              <span class="ui-icon ui-icon-comment left"></span>
            </b>
            <pre><%= line %></pre>
          </td>
        </tr>
      <% end %>
    </table>
  </div>
<% end %>

